{% extends "base.html" %}

{% block title %}Empleados - Task Manager{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2>
            <i class="fas fa-users"></i> Gesti칩n de Empleados
        </h2>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="toggleShowInactive()">
                <i class="fas fa-eye" id="toggleIcon"></i> 
                <span id="toggleText">Mostrar Inactivos</span>
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#employeeModal" onclick="openAddModal()">
                <i class="fas fa-plus"></i> Nuevo Empleado
            </button>
        </div>
    </div>
</div>

<!-- Estad칤sticas r치pidas -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2">Total Empleados</h6>
                <h3 class="card-title mb-0" id="stat-total">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2">Activos</h6>
                <h3 class="card-title mb-0" id="stat-active">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2">Trabajando Ahora</h6>
                <h3 class="card-title mb-0" id="stat-working">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2">Inactivos</h6>
                <h3 class="card-title mb-0" id="stat-inactive">0</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Lista de Empleados</h5>
                    </div>
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="游댌 Buscar por nombre, email o puesto...">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="employees-container">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando empleados...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para a침adir/editar empleado -->
<div class="modal fade" id="employeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-user-plus"></i> Nuevo Empleado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <input type="hidden" id="employee_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-user"></i> Nombre Completo *
                                </label>
                                <input type="text" class="form-control" id="name" required 
                                       placeholder="Ej: Ana Garc칤a L칩pez">
                                <div class="form-text">Nombre completo del empleado</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope"></i> Email Corporativo *
                                </label>
                                <input type="email" class="form-control" id="email" required 
                                       placeholder="ana.garcia@empresa.com">
                                <div class="form-text">Email 칰nico para identificaci칩n y futuro login</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="position" class="form-label">
                                    <i class="fas fa-briefcase"></i> Puesto de Trabajo
                                </label>
                                <input type="text" class="form-control" id="position" 
                                       placeholder="Ej: Desarrollador Senior">
                                <div class="form-text">Cargo o rol en la empresa</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="is_active" class="form-label">
                                    <i class="fas fa-toggle-on"></i> Estado
                                </label>
                                <select class="form-select" id="is_active">
                                    <option value="true" selected>Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                                <div class="form-text">Los empleados inactivos no pueden ser asignados</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos preparados para futuras funcionalidades -->
                    <div class="collapse" id="advancedFields">
                        <hr>
                        <h6 class="text-muted"><i class="fas fa-cog"></i> Campos Avanzados (Pr칩ximamente)</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-phone"></i> Tel칠fono
                                    </label>
                                    <input type="tel" class="form-control" disabled 
                                           placeholder="+34 600 000 000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-building"></i> Departamento
                                    </label>
                                    <input type="text" class="form-control" disabled 
                                           placeholder="Ej: Desarrollo">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end">
                        <a class="btn btn-sm btn-link" data-bs-toggle="collapse" href="#advancedFields">
                            <i class="fas fa-chevron-down"></i> Campos adicionales
                        </a>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEmployee()">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci칩n para desactivar -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Acci칩n
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">쮼st치s seguro de que deseas realizar esta acci칩n?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let allEmployees = [];
let showInactive = false;
let editingEmployeeId = null;

// Cargar empleados al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadEmployees();
    
    // B칰squeda en tiempo real
    document.getElementById('searchInput').addEventListener('input', function(e) {
        filterEmployees(e.target.value);
    });
});

// Cargar todos los empleados
async function loadEmployees() {
    try {
        const response = await axios.get('/employees/api');
        allEmployees = response.data.employees;
        updateStats();
        displayEmployees();
    } catch (error) {
        console.error('Error al cargar empleados:', error);
        showError('Error al cargar la lista de empleados');
    }
}

// Actualizar estad칤sticas
function updateStats() {
    const total = allEmployees.length;
    const active = allEmployees.filter(e => e.is_active).length;
    const inactive = total - active;
    
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-active').textContent = active;
    document.getElementById('stat-inactive').textContent = inactive;
    
    // Obtener empleados trabajando (esto requerir칤a una llamada adicional a la API)
    loadWorkingEmployees();
}

// Obtener empleados trabajando actualmente
async function loadWorkingEmployees() {
    try {
        const response = await axios.get('/assignments/api/current');
        const workingCount = new Set(response.data.assignments.map(a => a.employee_id)).size;
        document.getElementById('stat-working').textContent = workingCount;
    } catch (error) {
        document.getElementById('stat-working').textContent = '0';
    }
}

// Mostrar empleados
function displayEmployees() {
    const container = document.getElementById('employees-container');
    
    // Filtrar seg칰n estado
    let employees = showInactive ? allEmployees : allEmployees.filter(e => e.is_active);
    
    if (employees.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                No hay empleados ${showInactive ? '' : 'activos'} registrados.
                <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" 
                        data-bs-target="#employeeModal" onclick="openAddModal()">
                    <i class="fas fa-plus"></i> A침adir Primero
                </button>
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead class="table-light">';
    html += '<tr>';
    html += '<th width="5%"><i class="fas fa-hashtag"></i></th>';
    html += '<th width="25%"><i class="fas fa-user"></i> Nombre</th>';
    html += '<th width="25%"><i class="fas fa-envelope"></i> Email</th>';
    html += '<th width="20%"><i class="fas fa-briefcase"></i> Puesto</th>';
    html += '<th width="10%"><i class="fas fa-circle-check"></i> Estado</th>';
    html += '<th width="15%" class="text-center"><i class="fas fa-cog"></i> Acciones</th>';
    html += '</tr>';
    html += '</thead><tbody>';
    
    employees.forEach((emp, index) => {
        const statusBadge = emp.is_active 
            ? '<span class="badge bg-success"><i class="fas fa-check"></i> Activo</span>'
            : '<span class="badge bg-secondary"><i class="fas fa-ban"></i> Inactivo</span>';
        
        const rowClass = emp.is_active ? '' : 'table-secondary';
        
        html += `<tr class="${rowClass}">`;
        html += `<td class="text-muted">${index + 1}</td>`;
        html += `<td><strong>${emp.name}</strong></td>`;
        html += `<td><small>${emp.email}</small></td>`;
        html += `<td>${emp.position || '<span class="text-muted">-</span>'}</td>`;
        html += `<td>${statusBadge}</td>`;
        html += `<td class="text-center">`;
        html += `<div class="btn-group btn-group-sm" role="group">`;
        html += `<button class="btn btn-outline-info" onclick="viewHistory(${emp.id})" title="Ver historial">
                    <i class="fas fa-history"></i>
                 </button>`;
        html += `<button class="btn btn-outline-primary" onclick="editEmployee(${emp.id})" title="Editar">
                    <i class="fas fa-edit"></i>
                 </button>`;
        
        if (emp.is_active) {
            html += `<button class="btn btn-outline-warning" onclick="confirmToggleStatus(${emp.id}, false)" title="Desactivar">
                        <i class="fas fa-toggle-off"></i>
                     </button>`;
        } else {
            html += `<button class="btn btn-outline-success" onclick="confirmToggleStatus(${emp.id}, true)" title="Activar">
                        <i class="fas fa-toggle-on"></i>
                     </button>`;
        }
        
        html += `</div></td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Filtrar empleados por b칰squeda
function filterEmployees(searchTerm) {
    const container = document.getElementById('employees-container');
    searchTerm = searchTerm.toLowerCase().trim();
    
    if (searchTerm === '') {
        displayEmployees();
        return;
    }
    
    let employees = showInactive ? allEmployees : allEmployees.filter(e => e.is_active);
    employees = employees.filter(emp => 
        emp.name.toLowerCase().includes(searchTerm) ||
        emp.email.toLowerCase().includes(searchTerm) ||
        (emp.position && emp.position.toLowerCase().includes(searchTerm))
    );
    
    if (employees.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-search"></i> 
                No se encontraron empleados que coincidan con "${searchTerm}"
            </div>
        `;
        return;
    }
    
    // Mostrar resultados de b칰squeda (reutilizar l칩gica de display)
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead class="table-light">';
    html += '<tr><th>Nombre</th><th>Email</th><th>Puesto</th><th>Estado</th><th class="text-center">Acciones</th></tr>';
    html += '</thead><tbody>';
    
    employees.forEach(emp => {
        const statusBadge = emp.is_active 
            ? '<span class="badge bg-success">Activo</span>'
            : '<span class="badge bg-secondary">Inactivo</span>';
        
        html += `<tr>`;
        html += `<td><strong>${emp.name}</strong></td>`;
        html += `<td><small>${emp.email}</small></td>`;
        html += `<td>${emp.position || '-'}</td>`;
        html += `<td>${statusBadge}</td>`;
        html += `<td class="text-center">`;
        html += `<div class="btn-group btn-group-sm">`;
        html += `<button class="btn btn-outline-info" onclick="viewHistory(${emp.id})"><i class="fas fa-history"></i></button>`;
        html += `<button class="btn btn-outline-primary" onclick="editEmployee(${emp.id})"><i class="fas fa-edit"></i></button>`;
        html += `<button class="btn btn-outline-warning" onclick="confirmToggleStatus(${emp.id}, ${!emp.is_active})">
                    <i class="fas fa-toggle-${emp.is_active ? 'off' : 'on'}"></i>
                 </button>`;
        html += `</div></td></tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// Toggle mostrar inactivos
function toggleShowInactive() {
    showInactive = !showInactive;
    document.getElementById('toggleText').textContent = showInactive ? 'Ocultar Inactivos' : 'Mostrar Inactivos';
    document.getElementById('toggleIcon').className = showInactive ? 'fas fa-eye-slash' : 'fas fa-eye';
    displayEmployees();
}

// Abrir modal para a침adir
function openAddModal() {
    editingEmployeeId = null;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Nuevo Empleado';
    document.getElementById('employeeForm').reset();
    document.getElementById('employee_id').value = '';
    document.getElementById('is_active').value = 'true';
}

// Editar empleado
function editEmployee(employeeId) {
    const employee = allEmployees.find(e => e.id === employeeId);
    if (!employee) return;
    
    editingEmployeeId = employeeId;
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-edit"></i> Editar Empleado';
    document.getElementById('employee_id').value = employee.id;
    document.getElementById('name').value = employee.name;
    document.getElementById('email').value = employee.email;
    document.getElementById('position').value = employee.position || '';
    document.getElementById('is_active').value = employee.is_active.toString();
    
    const modal = new bootstrap.Modal(document.getElementById('employeeModal'));
    modal.show();
}

// Guardar empleado (crear o actualizar)
async function saveEmployee() {
    const form = document.getElementById('employeeForm');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const data = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        position: document.getElementById('position').value.trim(),
        is_active: document.getElementById('is_active').value === 'true'
    };
    
    try {
        if (editingEmployeeId) {
            // Actualizar
            await axios.put(`/employees/api/${editingEmployeeId}`, data);
            showSuccess('Empleado actualizado correctamente');
        } else {
            // Crear
            await axios.post('/employees/api', data);
            showSuccess('Empleado creado correctamente');
        }
        
        // Cerrar modal y recargar
        bootstrap.Modal.getInstance(document.getElementById('employeeModal')).hide();
        await loadEmployees();
        
    } catch (error) {
        const message = error.response?.data?.error || 'Error desconocido';
        showError('Error al guardar: ' + message);
    }
}

// Confirmar cambio de estado
function confirmToggleStatus(employeeId, newStatus) {
    const employee = allEmployees.find(e => e.id === employeeId);
    const action = newStatus ? 'activar' : 'desactivar';
    
    document.getElementById('confirmMessage').innerHTML = `
        쮼st치s seguro de que deseas <strong>${action}</strong> a <strong>${employee.name}</strong>?
        ${!newStatus ? '<br><small class="text-muted">Los empleados inactivos no pueden ser asignados a tareas.</small>' : ''}
    `;
    
    document.getElementById('confirmButton').onclick = () => toggleEmployeeStatus(employeeId, newStatus);
    
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// Cambiar estado del empleado
async function toggleEmployeeStatus(employeeId, newStatus) {
    try {
        await axios.put(`/employees/api/${employeeId}`, { is_active: newStatus });
        showSuccess(`Empleado ${newStatus ? 'activado' : 'desactivado'} correctamente`);
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        await loadEmployees();
    } catch (error) {
        showError('Error al cambiar el estado del empleado');
    }
}

// Ver historial del empleado
function viewHistory(employeeId) {
    const employee = allEmployees.find(e => e.id === employeeId);
    // Por ahora, mostrar alerta - luego se puede crear una p치gina dedicada
    alert(`Ver historial de ${employee.name}\n\nPr칩ximamente: p치gina de historial completo con todas las tareas asignadas.`);
    
    // Para implementar m치s tarde:
    // window.location.href = `/employees/${employeeId}/history`;
}

// Funciones de utilidad para mostrar mensajes
function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => alert.remove(), 3000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => alert.remove(), 5000);
}
</script>
{% endblock %}