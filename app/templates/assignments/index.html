{% extends "base.html" %}

{% block title %}Asignaciones - Task Manager{% endblock %}

{% block extra_css %}
<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
    .timer-display {
        font-size: 2rem;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }
    
    .employee-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .employee-card.working {
        border-left-color: #0dcaf0;
        background-color: #e7f7ff;
    }
    
    .employee-card.idle {
        border-left-color: #198754;
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2>
            <i class="fas fa-clipboard-list"></i> Control de Asignaciones
        </h2>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="refreshAll()">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
            <button class="btn btn-info" onclick="showHistoryModal()">
                <i class="fas fa-history"></i> Ver Historial
            </button>
        </div>
    </div>
</div>

<script>
// Variables globales del usuario actual
const CURRENT_USER_ID = {{ current_user.id }};
const IS_ADMIN = {{ 'true' if current_user.is_admin() else 'false' }};
console.log('Usuario actual:', { id: CURRENT_USER_ID, isAdmin: IS_ADMIN });
</script>

<!-- EstadÃ­sticas -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2">En Progreso</h6>
                <h3 class="card-title mb-0" id="stat-inprogreso">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2">Completadas Hoy</h6>
                <h3 class="card-title mb-0" id="stat-completed">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white" style="border-left: 4px solid #0dcaf0;">
            <div class="card-body">
                <h6 class="card-subtitle mb-2"><i class="fas fa-coffee"></i> En Descanso</h6>
                <h3 class="card-title mb-0" id="stat-paused">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-subtitle mb-2"><i class="fas fa-users"></i> Empleados Activos</h6>
                <h3 class="card-title mb-0" id="stat-working">0</h3>
            </div>
        </div>
    </div>
</div>

<!-- Panel principal: Empleados con START/STOP -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header {% if current_user.is_admin() %}bg-primary{% else %}bg-success{% endif %} text-white">
                <h5 class="mb-0">
                    {% if current_user.is_admin() %}
                    <i class="fas fa-users-cog"></i> Control de Todos los Empleados
                    <small class="float-end">Modo Administrador</small>
                    {% else %}
                    <i class="fas fa-user"></i> Mi Panel de Control
                    <small class="float-end">ActualizaciÃ³n automÃ¡tica cada 10s</small>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if not current_user.is_admin() %}
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Vista de Empleado:</strong> AquÃ­ puedes iniciar y gestionar tus propias tareas.
                </div>
                {% endif %}
                <div id="employees-control">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tareas en progreso -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-tasks"></i> Tareas en progeso de todos los empleados
                    <!-- {% if not current_user.is_admin() %}
                    <span class="badge bg-info ms-2">Solo Lectura</span>
                    {% endif %}-->
                </h5>
            </div>
            <div class="card-body">
                <div id="active-assignments">
                    <p class="text-muted">No hay tareas en progreso</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Completar Tareas -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Marcar Tareas como Completadas
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle"></i> 
                    AquÃ­ puedes marcar como completadas las tareas que has finalizado recientemente.
                </p>
                <button class="btn btn-success" onclick="openCompleteTasksModal()">
                    <i class="fas fa-list-check"></i> Ver Mis Tareas para Completar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para iniciar tarea o descanso -->
<div class="modal fade" id="startTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-play-circle"></i> Â¿QuÃ© vas a hacer?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="selected_employee_id">
                <h6 class="mb-3">
                    <i class="fas fa-user"></i> Empleado: 
                    <strong id="selected_employee_name"></strong>
                </h6>
                
                <!-- OpciÃ³n 1: Seleccionar Tarea -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-tasks"></i> Iniciar una Tarea
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="task_select" class="form-label">Selecciona una Tarea</label>
                            <select class="form-select form-select-lg" id="task_select">
                                <option value="">Cargando tareas...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="text-center my-3">
                    <strong class="text-muted">--- O ---</strong>
                </div>
                
                <!-- OpciÃ³n 2: Tomar Descanso -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-coffee"></i> Tomar un Descanso
                    </div>
                    <div class="card-body text-center">
                        <p class="mb-3">Registra tu tiempo de descanso</p>
                        <button type="button" class="btn btn-info btn-lg" onclick="startBreak()">
                            <i class="fas fa-coffee"></i> Iniciar Descanso
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="assignment_notes" class="form-label">
                        <i class="fas fa-sticky-note"></i> Notas (Opcional)
                    </label>
                    <textarea class="form-control" id="assignment_notes" rows="2" 
                              placeholder="AÃ±ade cualquier nota..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success btn-lg" onclick="startTask()">
                    <i class="fas fa-play"></i> Iniciar Tarea
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detener tarea -->
<!-- Modal de detener con 3 opciones - YA NO SE USA (simplificado a SweetAlert2) -->
<!--
<div class="modal fade" id="stopTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-stop-circle"></i> Â¿QuÃ© quieres hacer?
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="stop_assignment_id">
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-user"></i> <span id="stop_employee_name"></span></h6>
                    <h6><i class="fas fa-tasks"></i> <span id="stop_task_name"></span></h6>
                    <p class="mb-0"><i class="fas fa-clock"></i> Tiempo trabajado: <strong id="stop_duration"></strong></p>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card h-100 border-warning" style="cursor: pointer;" onclick="selectStopAction('stop')">
                            <div class="card-body text-center">
                                <i class="fas fa-pause-circle fa-3x text-warning mb-3"></i>
                                <h6>Simplemente Detener</h6>
                                <p class="small text-muted">Parar temporalmente para cambiar a otra tarea</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card h-100 border-info" style="cursor: pointer;" onclick="selectStopAction('break')">
                            <div class="card-body text-center">
                                <i class="fas fa-coffee fa-3x text-info mb-3"></i>
                                <h6>Tomar Descanso</h6>
                                <p class="small text-muted">Registrar tiempo de descanso</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card h-100 border-success" style="cursor: pointer;" onclick="selectStopAction('complete')">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h6>Marcar Completada</h6>
                                <p class="small text-muted">Tarea finalizada exitosamente</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label for="stop_notes" class="form-label">
                        <i class="fas fa-sticky-note"></i> Notas (Opcional)
                    </label>
                    <textarea class="form-control" id="stop_notes" rows="2" 
                              placeholder="AÃ±ade notas sobre lo realizado..."></textarea>
                </div>
                
                <input type="hidden" id="selected_stop_action" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="confirmStopAction()" id="confirmStopBtn" disabled>
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>
-->

<!-- Modal de historial -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-history"></i> Historial de Asignaciones
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="history_status_filter" onchange="loadHistory()">
                            <option value="">Todos los estados</option>
                            <option value="completada" selected>Completadas</option>
                            <option value="pausada">Pausadas</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="history_employee_filter" onchange="loadHistory()">
                            <option value="">Todos los empleados</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="history_date_filter" onchange="loadHistory()">
                    </div>
                </div>
                <div id="history-container">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Completar Tareas -->
<div class="modal fade" id="completeTasksModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle"></i> Marcar Tareas como Completadas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    Selecciona las tareas que has finalizado para marcarlas como completadas.
                </p>
                <div id="completable-tasks-list">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando tareas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Variables globales
let allEmployees = [];
let allTasks = [];
let currentAssignments = [];
let refreshInterval;
let globalTimerInterval = null; // Timer global para todos los contadores

// Cargar al iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadAll();
    
    // Actualizar cada 10 segundos
    refreshInterval = setInterval(() => {
        loadCurrentAssignments();
        // Los timers se actualizan automÃ¡ticamente con globalTimerInterval
    }, 10000);
});

// Cargar todo
async function loadAll() {
    // Cargar empleados, tareas y asignaciones en paralelo
    await Promise.all([
        loadEmployees(),
        loadTasks(),
        loadCurrentAssignments()
    ]);
    
    // Cargar stats DESPUÃ‰S de tener currentAssignments
    await loadStats();
    
    // Mostrar UI
    displayEmployeesControl();
}

// Refrescar todo manualmente
async function refreshAll() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    
    await loadAll();
    
    icon.classList.remove('fa-spin');
    showSuccess('Datos actualizados');
}

// Cargar empleados
async function loadEmployees() {
    try {
        const response = await fetch('/employees/api?active_only=true');
        const data = await response.json();
        allEmployees = data.employees;
    } catch (error) {
        console.error('Error al cargar empleados:', error);
    }
}

// Cargar tareas
async function loadTasks() {
    try {
        const response = await fetch('/tasks/api?active_only=true');
        const data = await response.json();
        allTasks = data.tasks;
    } catch (error) {
        console.error('Error al cargar tareas:', error);
    }
}

// Cargar asignaciones actuales
async function loadCurrentAssignments() {
    try {
        console.log('ðŸ”„ Cargando asignaciones actuales...');
        const response = await fetch('/assignments/api/current');
        const data = await response.json();
        currentAssignments = data.assignments;
        console.log('ðŸ“‹ Asignaciones cargadas:', currentAssignments.length, currentAssignments);
        displayActiveAssignments();
        displayEmployeesControl();
    } catch (error) {
        console.error('Error al cargar asignaciones:', error);
    }
}

// Cargar estadÃ­sticas
async function loadStats() {
    try {
        console.log('ðŸ” Cargando estadÃ­sticas...');
        console.log('ðŸ“Š currentAssignments:', currentAssignments);
        
        // En progreso (trabajando)
        const inProgressResp = await fetch('/assignments/api?status=en_progreso');
        const inProgressData = await inProgressResp.json();
        console.log('âœ… En progreso:', inProgressData.assignments.length, inProgressData.assignments);
        document.getElementById('stat-inprogreso').textContent = inProgressData.assignments.length;
        
        // Completadas hoy
        const today = new Date().toISOString().split('T')[0];
        const completedResp = await fetch(`/assignments/api?status=completada&start_date=${today}`);
        const completedData = await completedResp.json();
        console.log('âœ… Completadas hoy:', completedData.assignments.length);
        document.getElementById('stat-completed').textContent = completedData.assignments.length;
        
        // En descanso
        const breakResp = await fetch('/assignments/api?status=descanso');
        const breakData = await breakResp.json();
        console.log('â˜• En descanso:', breakData.assignments.length, breakData.assignments);
        document.getElementById('stat-paused').textContent = breakData.assignments.length;
        
        // Empleados activos (trabajando o en descanso)
        const workingEmployees = new Set(currentAssignments.map(a => a.employee_id)).size;
        console.log('ðŸ‘¥ Empleados activos:', workingEmployees);
        console.log('ðŸ‘¥ IDs Ãºnicos:', Array.from(new Set(currentAssignments.map(a => a.employee_id))));
        document.getElementById('stat-working').textContent = workingEmployees;
        
        console.log('âœ… EstadÃ­sticas cargadas correctamente');
        
    } catch (error) {
        console.error('âŒ Error al cargar estadÃ­sticas:', error);
    }
}

// Obtener empleados que han fichado hoy
async function getCheckedInEmployees() {
    try {
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`/attendance/api?date=${today}`);
        const data = await response.json();
        
        // Devolver IDs de empleados con fichaje activo (check_in pero sin check_out)
        const checkedInIds = data.attendance
            .filter(record => !record.check_out)  // Sin check_out = aÃºn fichado
            .map(record => record.employee_id);
        
        return checkedInIds;
    } catch (error) {
        console.error('Error al obtener empleados fichados:', error);
        return [];
    }
}

// Mostrar control de empleados con START/STOP
async function displayEmployeesControl() {
    const container = document.getElementById('employees-control');
    
    // Obtener empleados fichados hoy
    const checkedInEmployees = await getCheckedInEmployees();
    console.log('ðŸ‘¥ Empleados fichados hoy:', checkedInEmployees);
    
    // Si no es admin, filtrar solo el empleado actual
    let employeesToShow = allEmployees;
    if (!IS_ADMIN) {
        employeesToShow = allEmployees.filter(emp => emp.id === CURRENT_USER_ID);
        console.log('Modo empleado: mostrando solo usuario actual');
    } else {
        console.log('Modo admin: mostrando todos los empleados');
    }
    
    // FILTRAR: Solo mostrar empleados que han fichado hoy
    employeesToShow = employeesToShow.filter(emp => checkedInEmployees.includes(emp.id));
    console.log('ðŸ‘¥ Empleados fichados a mostrar:', employeesToShow.length);
    
    if (employeesToShow.length === 0) {
        const message = IS_ADMIN 
            ? 'No hay empleados fichados. Los empleados deben fichar primero en la secciÃ³n de Fichaje para poder gestionar tareas.' 
            : 'No has fichado hoy. Debes fichar primero en la secciÃ³n de Fichaje para poder iniciar tareas.';
        
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-clock"></i> 
                <strong>Fichaje requerido:</strong> ${message}
                <a href="/attendance" class="btn btn-sm btn-warning mt-2">
                    <i class="fas fa-fingerprint"></i> Ir a Fichaje
                </a>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row g-3 justify-content-center">';
    
    employeesToShow.forEach(employee => {
        const assignment = currentAssignments.find(a => a.employee_id === employee.id);
        const isWorking = !!assignment;
        const isBreak = assignment && assignment.status === 'descanso';
        
        html += '<div class="col-md-6 col-lg-4">';
        html += `<div class="card employee-card ${isWorking ? (isBreak ? 'border-info' : 'working') : 'idle'} h-100">`;
        html += '<div class="card-body">';
        
        // Encabezado
        html += '<div class="d-flex justify-content-between align-items-center mb-2">';
        html += `<h5 class="card-title mb-0"><i class="fas fa-user"></i> ${employee.name}</h5>`;
        
        if (isBreak) {
            html += `<span class="badge bg-info pulse">
                        <i class="fas fa-coffee"></i> En Descanso
                     </span>`;
        } else if (isWorking) {
            html += `<span class="badge bg-primary pulse">
                        <i class="fas fa-circle"></i> Trabajando
                     </span>`;
        } else {
            html += `<span class="badge bg-success">
                        <i class="fas fa-check"></i> Disponible
                     </span>`;
        }
        html += '</div>';
        
        html += `<p class="text-muted small mb-3"><i class="fas fa-briefcase"></i> ${employee.position || 'Sin puesto'}</p>`;
        
        if (isWorking) {
            // Mostrar tarea/descanso actual y temporizador
            html += '<div class="bg-white p-3 rounded mb-3">';
            
            if (isBreak) {
                html += `<h6 class="mb-2"><i class="fas fa-coffee"></i> â˜• Descanso</h6>`;
            } else {
                html += `<h6 class="mb-2"><i class="fas fa-tasks"></i> ${assignment.task_name}</h6>`;
            }
            
            html += `<div class="timer-display ${isBreak ? 'text-info' : 'text-primary'}" id="timer-${assignment.id}">00:00:00</div>`;
            html += `<small class="text-muted">Iniciado: ${formatTime(assignment.start_time)}</small>`;
            
            if (assignment.notes) {
                html += `<p class="small mt-2 mb-0"><i class="fas fa-sticky-note"></i> ${assignment.notes}</p>`;
            }
            html += '</div>';
            
            // BotÃ³n segÃºn estado
            if (isBreak) {
                html += `<button class="btn btn-info btn-lg w-100" onclick="confirmStopTask(${assignment.id}, true)">
                            <i class="fas fa-stop-circle"></i> FINALIZAR DESCANSO
                         </button>`;
            } else {
                html += `<button class="btn btn-danger btn-lg w-100" onclick="confirmStopTask(${assignment.id}, false)">
                            <i class="fas fa-stop"></i> DETENER
                         </button>`;
            }
        } else {
            // BotÃ³n INICIAR
            html += `<button class="btn btn-success btn-lg w-100" onclick="openStartModal(${employee.id}, '${employee.name}')">
                        <i class="fas fa-play"></i> INICIAR
                     </button>`;
        }
        
        html += '</div></div></div>';
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Iniciar timers globales despuÃ©s de renderizar
    startGlobalTimers();
}

// Inicializar sistema de timers global (similar a fichaje)
function startGlobalTimers() {
    // Detener timer anterior si existe
    if (globalTimerInterval) {
        clearInterval(globalTimerInterval);
    }
    
    // FunciÃ³n que actualiza TODOS los timers a la vez
    const updateAllTimers = () => {
        currentAssignments.forEach(assignment => {
            updateSingleTimer(assignment);
        });
    };
    
    // Primera actualizaciÃ³n inmediata
    updateAllTimers();
    
    // Actualizar cada segundo
    globalTimerInterval = setInterval(updateAllTimers, 1000);
}

// Actualizar un timer individual
function updateSingleTimer(assignment) {
    // Buscar el elemento del timer
    const timerElement = document.getElementById(`timer-${assignment.id}`);
    if (!timerElement) return;
    
    // Determinar color segÃºn estado
    if (assignment.status === 'descanso' || assignment.is_break) {
        timerElement.classList.add('text-info');
        timerElement.classList.remove('text-primary', 'text-warning');
    } else if (assignment.status === 'detenida') {
        timerElement.classList.add('text-warning');
        timerElement.classList.remove('text-primary', 'text-info');
    } else {
        timerElement.classList.add('text-primary');
        timerElement.classList.remove('text-warning', 'text-info');
    }
    
    // Calcular tiempo transcurrido (igual que en fichaje)
    const startDate = new Date(assignment.start_time);
    const now = new Date();
    const elapsed = now - startDate;
    
    // Calcular horas, minutos y segundos
    const hours = Math.floor(elapsed / 3600000);
    const minutes = Math.floor((elapsed % 3600000) / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    
    // Actualizar display
    timerElement.textContent = 
        `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    
    // TambiÃ©n actualizar badge en tabla si existe
    const badgeElement = document.getElementById(`badge-timer-${assignment.id}`);
    if (badgeElement) {
        badgeElement.textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes} min`;
    }
}

// Mostrar tareas activas
function displayActiveAssignments() {
    const container = document.getElementById('active-assignments');
    
    if (currentAssignments.length === 0) {
        container.innerHTML = '<p class="text-muted"><i class="fas fa-info-circle"></i> No hay tareas en progreso</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead><tr>';
    html += '<th><i class="fas fa-user"></i> Empleado</th>';
    html += '<th><i class="fas fa-tasks"></i> Tarea</th>';
    html += '<th><i class="fas fa-clock"></i> Tiempo</th>';
    html += '<th><i class="fas fa-play-circle"></i> Inicio</th>';
    html += '</tr></thead><tbody>';
    
    currentAssignments.forEach(assignment => {
        const isBreak = assignment.status === 'descanso' || assignment.is_break;
        const badgeColor = isBreak ? 'bg-info' : 'bg-primary';
        const icon = isBreak ? 'fa-coffee' : 'fa-tasks';
        
        html += '<tr>';
        html += `<td><strong>${assignment.employee_name}</strong></td>`;
        html += `<td>
                    <i class="fas ${icon}"></i> ${assignment.task_name}
                    ${isBreak ? '<span class="badge bg-info ms-1">Descanso</span>' : ''}
                 </td>`;
        html += `<td><span class="badge ${badgeColor}" id="badge-timer-${assignment.id}">Calculando...</span></td>`;
        html += `<td><small>${formatDateTime(assignment.start_time)}</small></td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
    // Los timers se actualizan automÃ¡ticamente con el sistema global
}

// Abrir modal para iniciar tarea
async function openStartModal(employeeId, employeeName) {
    document.getElementById('selected_employee_id').value = employeeId;
    document.getElementById('selected_employee_name').textContent = employeeName;
    document.getElementById('assignment_notes').value = '';
    
    // Cargar tareas disponibles para este empleado especÃ­fico
    const taskSelect = document.getElementById('task_select');
    taskSelect.innerHTML = '<option value="">Cargando tareas disponibles...</option>';
    
    try {
        const response = await fetch(`/tasks/api/available-for/${employeeId}`);
        const data = await response.json();
        const availableTasks = data.tasks;
        
        taskSelect.innerHTML = '<option value="">Selecciona una tarea...</option>';
        
        if (availableTasks.length === 0) {
            taskSelect.innerHTML = '<option value="">No hay tareas disponibles para este empleado</option>';
        } else {
            availableTasks.forEach(task => {
                const duration = task.estimated_duration ? ` (${task.estimated_duration} min)` : '';
                const category = task.category ? ` [${task.category}]` : '';
                taskSelect.innerHTML += `<option value="${task.id}">${task.name}${category}${duration}</option>`;
            });
        }
    } catch (error) {
        console.error('Error al cargar tareas:', error);
        taskSelect.innerHTML = '<option value="">Error al cargar tareas</option>';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('startTaskModal'));
    modal.show();
}

// Iniciar tarea
async function startTask() {
    const employeeId = document.getElementById('selected_employee_id').value;
    const taskId = document.getElementById('task_select').value;
    const notes = document.getElementById('assignment_notes').value;
    
    if (!taskId) {
        alert('Por favor selecciona una tarea');
        return;
    }
    
    try {
        const response = await fetch('/assignments/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                employee_id: parseInt(employeeId),
                task_id: parseInt(taskId),
                is_break: false,
                notes: notes
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al iniciar');
        }
        
        showSuccess('Â¡Tarea iniciada! El temporizador estÃ¡ corriendo.');
        bootstrap.Modal.getInstance(document.getElementById('startTaskModal')).hide();
        
        await loadAll();
        
    } catch (error) {
        console.error('Error al iniciar tarea:', error);
        showError('Error al iniciar tarea: ' + error.message);
    }
}

// Iniciar descanso
async function startBreak() {
    const employeeId = document.getElementById('selected_employee_id').value;
    const notes = document.getElementById('assignment_notes').value || 'â˜• Descanso';
    
    try {
        const response = await fetch('/assignments/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                employee_id: parseInt(employeeId),
                is_break: true,
                notes: notes
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al iniciar descanso');
        }
        
        showSuccess('â˜• Â¡Descanso iniciado! RelÃ¡jate.');
        bootstrap.Modal.getInstance(document.getElementById('startTaskModal')).hide();
        
        await loadAll();
        
    } catch (error) {
        console.error('Error al iniciar descanso:', error);
        showError('Error al iniciar descanso: ' + error.message);
    }
}

// ========== FUNCIONES PARA COMPLETAR TAREAS ==========

// Abrir modal para completar tareas
async function openCompleteTasksModal() {
    const modal = new bootstrap.Modal(document.getElementById('completeTasksModal'));
    modal.show();
    
    // Cargar tareas detenidas (pausadas) del empleado actual
    await loadCompletableTasks();
}

// Cargar tareas que pueden completarse
async function loadCompletableTasks() {
    const container = document.getElementById('completable-tasks-list');
    
    try {
        // Obtener asignaciones pausadas/detenidas del usuario actual
        const response = await fetch(`/assignments/api?status=pausada&employee_id=${CURRENT_USER_ID}`);
        const data = await response.json();
        const tasks = data.assignments;
        
        if (tasks.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    No tienes tareas detenidas para completar. 
                    DetÃ©n una tarea en progreso para poder marcarla como completada aquÃ­.
                </div>
            `;
            return;
        }
        
        let html = '<div class="list-group">';
        
        tasks.forEach(task => {
            // Calcular duraciÃ³n total
            const duration = parseDuration(task.total_duration);
            const durationText = duration.hours > 0 
                ? `${duration.hours}h ${duration.minutes}m` 
                : `${duration.minutes}m`;
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="fas fa-tasks text-primary"></i> ${task.task_name}
                            </h6>
                            <p class="mb-1 text-muted small">
                                <i class="fas fa-clock"></i> Tiempo trabajado: <strong>${durationText}</strong>
                            </p>
                            <p class="mb-1 text-muted small">
                                <i class="fas fa-calendar"></i> Iniciada: ${formatDateTime(task.start_time)}
                            </p>
                            ${task.notes ? `<p class="mb-0 text-muted small"><i class="fas fa-sticky-note"></i> ${task.notes}</p>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="markTaskAsCompleted(${task.id}, '${task.task_name}', '${durationText}')">
                                <i class="fas fa-check"></i> Completar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error al cargar tareas:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Error al cargar las tareas
            </div>
        `;
    }
}

// Marcar tarea como completada
async function markTaskAsCompleted(assignmentId, taskName, durationText) {
    const result = await Swal.fire({
        title: 'Â¿Marcar como completada?',
        html: `
            <div class="text-start">
                <p class="mb-2"><i class="fas fa-tasks text-success"></i> <strong>${taskName}</strong></p>
                <p class="mb-2"><i class="fas fa-clock text-info"></i> Tiempo total: <strong>${durationText}</strong></p>
                <p class="mb-0"><i class="fas fa-check-circle text-success"></i> La tarea se marcarÃ¡ como finalizada exitosamente.</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-check"></i> SÃ­, completar',
        cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
        reverseButtons: true
    });
    
    if (!result.isConfirmed) return;
    
    try {
        const response = await fetch(`/assignments/api/${assignmentId}/complete`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al completar');
        }
        
        // Alerta de Ã©xito
        await Swal.fire({
            title: 'Â¡Tarea completada!',
            html: `<p><strong>${taskName}</strong> marcada como completada.</p><p>Tiempo total: ${durationText}</p>`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        // Recargar listas
        await loadCompletableTasks();
        await loadAll();
        
    } catch (error) {
        console.error('Error:', error);
        await Swal.fire({
            title: 'Error',
            text: 'Error al completar tarea: ' + error.message,
            icon: 'error',
            confirmButtonColor: '#dc3545'
        });
    }
}

// ========== FIN FUNCIONES COMPLETAR TAREAS ==========

// Abrir modal de detener desde botÃ³n (con datos embebidos)
function openStopModalFromButton(button) {
    const assignmentData = JSON.parse(button.dataset.assignment);
    console.log('ðŸ›‘ Abriendo modal desde botÃ³n con datos:', assignmentData);
    
    document.getElementById('stop_assignment_id').value = assignmentData.id;
    document.getElementById('stop_employee_name').textContent = assignmentData.employee_name;
    document.getElementById('stop_task_name').textContent = assignmentData.task_name;
    document.getElementById('stop_notes').value = '';
    document.getElementById('selected_stop_action').value = '';
    document.getElementById('confirmStopBtn').disabled = true;
    
    // Limpiar selecciÃ³n visual
    document.querySelectorAll('#stopTaskModal .card').forEach(card => {
        card.classList.remove('border-3', 'shadow');
    });
    
    // Calcular duraciÃ³n
    const elapsed = Date.now() - new Date(assignmentData.start_time).getTime();
    const hours = Math.floor(elapsed / 3600000);
    const minutes = Math.floor((elapsed % 3600000) / 60000);
    document.getElementById('stop_duration').textContent = `${hours}h ${minutes}m`;
    
    const modal = new bootstrap.Modal(document.getElementById('stopTaskModal'));
    modal.show();
}

// Abrir modal de detener (versiÃ³n antigua para compatibilidad)
function openStopModal(assignmentId) {
    console.log('ðŸ›‘ Abriendo modal de detener para assignment:', assignmentId);
    console.log('ðŸ“‹ currentAssignments disponibles:', currentAssignments);
    
    const assignment = currentAssignments.find(a => a.id === assignmentId);
    
    if (!assignment) {
        console.error('âŒ No se encontrÃ³ el assignment con id:', assignmentId);
        Swal.fire({
            title: 'Error',
            text: 'No se pudo cargar la informaciÃ³n de la tarea. Por favor, recarga la pÃ¡gina.',
            icon: 'error',
            confirmButtonText: 'Recargar',
            confirmButtonColor: '#dc3545'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.reload();
            }
        });
        return;
    }
    
    console.log('âœ… Assignment encontrado:', assignment);
    
    document.getElementById('stop_assignment_id').value = assignmentId;
    document.getElementById('stop_employee_name').textContent = assignment.employee_name;
    document.getElementById('stop_task_name').textContent = assignment.task_name;
    document.getElementById('stop_notes').value = '';
    document.getElementById('selected_stop_action').value = '';
    document.getElementById('confirmStopBtn').disabled = true;
    
    // Limpiar selecciÃ³n visual
    document.querySelectorAll('#stopTaskModal .card').forEach(card => {
        card.classList.remove('border-3', 'shadow');
    });
    
    // Calcular duraciÃ³n
    const elapsed = Date.now() - new Date(assignment.start_time).getTime();
    const hours = Math.floor(elapsed / 3600000);
    const minutes = Math.floor((elapsed % 3600000) / 60000);
    document.getElementById('stop_duration').textContent = `${hours}h ${minutes}m`;
    
    const modal = new bootstrap.Modal(document.getElementById('stopTaskModal'));
    modal.show();
}

// Seleccionar acciÃ³n de detener
function selectStopAction(action) {
    document.getElementById('selected_stop_action').value = action;
    document.getElementById('confirmStopBtn').disabled = false;
    
    // Resaltar la opciÃ³n seleccionada
    document.querySelectorAll('#stopTaskModal .card').forEach(card => {
        card.classList.remove('border-3', 'shadow');
    });
    
    const actionMap = {
        'stop': 0,
        'break': 1,
        'complete': 2
    };
    
    const cards = document.querySelectorAll('#stopTaskModal .card');
    if (cards[actionMap[action]]) {
        cards[actionMap[action]].classList.add('border-3', 'shadow');
    }
    
    // Actualizar texto del botÃ³n
    const confirmBtn = document.getElementById('confirmStopBtn');
    const actionText = {
        'stop': 'Detener',
        'break': 'Iniciar Descanso',
        'complete': 'Completar Tarea'
    };
    confirmBtn.innerHTML = `<i class="fas fa-check"></i> ${actionText[action]}`;
}

// Detener tarea o descanso con SweetAlert2 (unificado)
async function confirmStopTask(assignmentId, isBreak) {
    // Obtener info de la asignaciÃ³n
    const assignment = currentAssignments.find(a => a.id === assignmentId);
    if (!assignment) {
        console.error('No se encontrÃ³ la asignaciÃ³n');
        await Swal.fire({
            title: 'Error',
            text: 'No se pudo cargar la informaciÃ³n. Por favor, recarga la pÃ¡gina.',
            icon: 'error',
            confirmButtonColor: '#dc3545'
        });
        return;
    }
    
    // Calcular duraciÃ³n
    const elapsed = Date.now() - new Date(assignment.start_time).getTime();
    const minutes = Math.floor(elapsed / 60000);
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    const durationText = hours > 0 ? `${hours}h ${remainingMinutes}m` : `${minutes} minutos`;
    
    // Textos segÃºn si es descanso o tarea
    const title = isBreak ? 'Â¿Finalizar descanso?' : 'Â¿Detener tarea?';
    const icon = isBreak ? 'fa-coffee' : 'fa-tasks';
    const color = isBreak ? 'info' : 'primary';
    const taskName = isBreak ? 'Descanso' : assignment.task_name;
    const successMessage = isBreak 
        ? 'Ya estÃ¡s disponible para iniciar tareas.' 
        : 'Tarea detenida. Puedes iniciar otra tarea o tomar un descanso.';
    
    // ConfirmaciÃ³n con SweetAlert2
    const result = await Swal.fire({
        title: title,
        html: `
            <div class="text-start">
                <p class="mb-2"><i class="fas ${icon} text-${color}"></i> <strong>${taskName}</strong></p>
                <p class="mb-2"><i class="fas fa-clock text-info"></i> <strong>DuraciÃ³n:</strong> ${durationText}</p>
                <p class="mb-0"><i class="fas fa-info-circle text-muted"></i> ${successMessage}</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: isBreak ? '#0dcaf0' : '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: `<i class="fas fa-check"></i> SÃ­, ${isBreak ? 'finalizar' : 'detener'}`,
        cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
        reverseButtons: true
    });
    
    if (!result.isConfirmed) return;
    
    try {
        // Detener la tarea/descanso
        const response = await fetch(`/assignments/api/${assignmentId}/stop`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                notes: isBreak ? `Descanso finalizado (${durationText})` : `Tarea detenida (${durationText})` 
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al detener');
        }
        
        // Alerta de Ã©xito con SweetAlert2
        await Swal.fire({
            title: isBreak ? 'Â¡Descanso finalizado!' : 'Â¡Tarea detenida!',
            html: `<p>DuraciÃ³n: <strong>${durationText}</strong></p><p>${successMessage}</p>`,
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        });
        
        await loadAll();
        
    } catch (error) {
        console.error('Error:', error);
        await Swal.fire({
            title: 'Error',
            text: 'Error al detener: ' + error.message,
            icon: 'error',
            confirmButtonColor: '#dc3545'
        });
    }
}

// FunciÃ³n antigua - mantener por compatibilidad pero redirigir a la nueva
async function confirmFinishBreak(assignmentId) {
    return confirmStopTask(assignmentId, true);
}

// Confirmar acciÃ³n de detener
async function confirmStopAction() {
    const assignmentId = document.getElementById('stop_assignment_id').value;
    const action = document.getElementById('selected_stop_action').value;
    const notes = document.getElementById('stop_notes').value;
    
    if (!action) {
        alert('Por favor selecciona una opciÃ³n');
        return;
    }
    
    try {
        let response;
        let message;
        
        if (action === 'stop') {
            // Simplemente detener
            response = await fetch(`/assignments/api/${assignmentId}/stop`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            });
            message = 'Tarea detenida. Puedes iniciar otra cuando quieras.';
            
        } else if (action === 'break') {
            // Detener tarea actual
            response = await fetch(`/assignments/api/${assignmentId}/stop`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Error al detener');
            }
            
            // Obtener el empleado de la asignaciÃ³n
            const assignment = currentAssignments.find(a => a.id == assignmentId);
            
            // Iniciar descanso
            response = await fetch('/assignments/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_id: assignment.employee_id,
                    is_break: true,
                    notes: notes || 'â˜• Descanso'
                })
            });
            message = 'â˜• Descanso iniciado. Â¡RelÃ¡jate!';
            
        } else if (action === 'complete') {
            // Marcar como completada
            response = await fetch(`/assignments/api/${assignmentId}/complete`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            });
            message = 'âœ… Â¡Tarea completada exitosamente!';
            
            // El timer global se encarga automÃ¡ticamente
        }
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Error al procesar');
        }
        
        showSuccess(message);
        bootstrap.Modal.getInstance(document.getElementById('stopTaskModal')).hide();
        
        await loadAll();
        
    } catch (error) {
        console.error('Error:', error);
        showError('Error: ' + error.message);
    }
}

// Mostrar modal de historial
async function showHistoryModal() {
    // Cargar empleados en filtro
    const empFilter = document.getElementById('history_employee_filter');
    empFilter.innerHTML = '<option value="">Todos los empleados</option>';
    allEmployees.forEach(emp => {
        empFilter.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
    });
    
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    modal.show();
    
    await loadHistory();
}

// Cargar historial
async function loadHistory() {
    const container = document.getElementById('history-container');
    container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
    
    try {
        let url = '/assignments/api?';
        const status = document.getElementById('history_status_filter').value;
        const employeeId = document.getElementById('history_employee_filter').value;
        const date = document.getElementById('history_date_filter').value;
        
        if (status) url += `status=${status}&`;
        if (employeeId) url += `employee_id=${employeeId}&`;
        if (date) url += `start_date=${date}&`;
        
        const response = await fetch(url);
        const data = await response.json();
        const assignments = data.assignments;
        
        if (assignments.length === 0) {
            container.innerHTML = '<div class="alert alert-info">No se encontraron asignaciones</div>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Empleado</th><th>Tarea</th><th>Inicio</th><th>Fin</th><th>DuraciÃ³n</th><th>Estado</th></tr></thead><tbody>';
        
        assignments.forEach(a => {
            const duration = a.end_time ? 
                calculateDuration(a.start_time, a.end_time) : '-';
            const statusBadge = {
                'completada': '<span class="badge bg-success">Completada</span>',
                'pausada': '<span class="badge bg-warning">Pausada</span>',
                'en_progreso': '<span class="badge bg-info">En Progreso</span>'
            }[a.status];
            
            html += `<tr>
                <td>${a.employee_name}</td>
                <td>${a.task_name}</td>
                <td><small>${formatDateTime(a.start_time)}</small></td>
                <td><small>${a.end_time ? formatDateTime(a.end_time) : '-'}</small></td>
                <td>${duration}</td>
                <td>${statusBadge}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
        
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Error al cargar historial</div>';
    }
}

// Funciones de utilidad
function formatTime(dateString) {
    return new Date(dateString).toLocaleTimeString('es-ES', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function calculateDuration(start, end) {
    const duration = new Date(end) - new Date(start);
    const hours = Math.floor(duration / 3600000);
    const minutes = Math.floor((duration % 3600000) / 60000);
    return hours > 0 ? `${hours}h ${minutes}m` : `${minutes} min`;
}

function parseDuration(durationStr) {
    // Parse "HH:MM:SS" format
    if (!durationStr) return { hours: 0, minutes: 0 };
    const parts = durationStr.split(':');
    return {
        hours: parseInt(parts[0]) || 0,
        minutes: parseInt(parts[1]) || 0
    };
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

// Limpiar intervalos al salir
window.addEventListener('beforeunload', () => {
    clearInterval(refreshInterval);
    if (globalTimerInterval) {
        clearInterval(globalTimerInterval);
    }
});
</script>
{% endblock %}